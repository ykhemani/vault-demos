
# Vault Agent Auto-Auth and Consul-Template Demo

[Vault Agent](https://www.vaultproject.io/docs/agent/) is a client daemon that provides the following features.
* Auto-Auth - Automatically authenticate to Vault and manage the token renewal process for locally-retrieved dynamic secrets.

* Caching - Allows client-side caching of responses containing newly created tokens and responses containing leased secrets generated off of these newly created tokens.

* Templating - Allows rendering of user supplied templates by Vault Agent, using the token generated by the Auto-Auth step.

[Consul-Template](https://github.com/hashicorp/consul-template) is also able to render templates, populating them with data from Vault or Consul. Consul-Template is limited in authenticating with Vault using only a token, but Consul-Template also allows us to run external commands.

We can authenticate with our Vault Cluster using Vault Agent with the authentication method of our choice, and write the token to a file that can then be consumed by Consul-Template. This enables us to call external commands if needed when a secret changes.

## Setup

The Vault Agent can [authenticate](https://www.vaultproject.io/docs/agent/autoauth/) with Vault in a number of ways.

In this example, we will use [AppRole Auth](https://www.vaultproject.io/docs/agent/autoauth/methods/approle/) to enable the Vault Agent to authenticate with the Vault Cluster.

### Environment variables

We will specify the environment variables required for our setup below.

### Enable and configure AppRole Auth

With a token that has attached to it an [admin policy](https://learn.hashicorp.com/vault/identity-access-management/iam-policies#policy-requirements), let's enable the AppRole auth method.

We will use an environment variable to assist in our setup.

```
export APPROLE_PATH=approle-demo
```

Let's enable the AppRole auth method.

```
vault auth disable ${APPROLE_PATH}
vault auth enable -path=${APPROLE_PATH} approle
```

### Create a named role

Let's create a named role that our Vault Agent will use to authenticate with the Vault cluster.

```
vault write auth/${APPROLE_PATH}/role/my-role \
    secret_id_ttl=0 \
    token_num_uses=0 \
    token_ttl=10s \
    token_max_ttl=30s \
    token_policies=my-demo-policy,my-oracle-db_policy,venafi-consumer-policy,cert-consumer-policy \
    secret_id_num_uses=0
```

### Orchestrate access for our client

Let's generate a Role ID to enable Vault Agent to authenticate with Vault.

```
export VAULT_ROLE_ID=$(vault read -format=json auth/${APPROLE_PATH}/role/my-role/role-id | jq -r '.data.role_id')
```

Let's see what that looks like.

```
echo $VAULT_ROLE_ID
```

Let's place our Role ID on the client.

```
ssh root@nuc01 "mkdir -p /data/demo; echo $VAULT_ROLE_ID > /data/demo/role_id"
```

Let's generate a Secret ID to enable Vault Agent to authenticate with Vault.

```
export VAULT_SECRET_ID=$(vault write -f -format=json auth/${APPROLE_PATH}/role/my-role/secret-id | jq -r '.data.secret_id')
```

Let's see what that looks like.

```
echo $VAULT_SECRET_ID
```

Let's place our Role ID on the client.

```
ssh root@nuc01 "mkdir -p /data/demo; echo $VAULT_SECRET_ID > /data/demo/secret_id"
```

### Client Setup

We will be working in the `/data/demo` directory.

Let's clean up any past runs.
```
export TOP=/data/demo
mkdir -p ${TOP}/pki
```

```
cd ${TOP}
```

Let's look at our Vault Agent config.

```
cat ${TOP}/vault-agent/etc/vault.d/vault-agent.hcl
```

Let's run Vault Agent in the foreground.

```
vault agent -config ${TOP}/vault-agent/etc/vault.d/vault-agent.hcl
```

Let's examine the token that Vault Agent received.

```
export TOP=/data/demo
export VAULT_ADDR=https://ns3.home.seva.cafe:8200
cat ${TOP}/vault-token-via-agent

VAULT_TOKEN=$(cat /data/demo/vault-token-via-agent) vault token lookup
```

Let's examine our `consul-template` configuration.

```
cat ${TOP}/consul-template/etc/consul-template/consul-template.hcl
```

Let's examine some of the templates.

```
cat /data/demo/pki/private_key.tpl
cat /data/demo/pki/certificate.tpl
```

Let's examine the command that is specified in the templates.

```
cat /data/demo/restart_script
```

Let's run `consul-template` in the foreground.

```
consul-template -config ${TOP}/consul-template/etc/consul-template/consul-template.hcl
```

Let's watch the resulting template destinations.

```
cat /data/demo/pki/private_key.pem
cat /data/demo/pki/certificate.pem
cat /data/demo/pki/expiration
```

Let's watch the log to which the command is writing.

```
tail -f /data/demo/log
```
